package com.apk.agrostore.presentation.healthbot

import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import java.util.*
import javax.inject.Inject
import kotlin.random.Random

@HiltViewModel
class HealthBotViewModel @Inject constructor(
    private val healthBotModel: HealthBotModel
) : ViewModel() {

    private val _uiState = MutableStateFlow(HealthBotUiState())
    val uiState: StateFlow<HealthBotUiState> = _uiState.asStateFlow()

    private var predictionJob: Job? = null
    private val currentSessionId = UUID.randomUUID().toString()

    fun updateInputText(newText: String) {
        _uiState.value = _uiState.value.copy(inputText = newText)
    }

    fun sendMessage() {
        val currentState = _uiState.value
        val userMessage = currentState.inputText.trim()

        if (userMessage.isEmpty()) return

        // Add user message
        val userChatMessage = ChatMessage(
            isUser = true,
            message = userMessage,
            sessionId = currentSessionId
        )

        _uiState.value = currentState.copy(
            messages = currentState.messages + userChatMessage,
            inputText = "",
            isLoading = true,
            error = null
        )

        // Simulate bot thinking and processing
        predictionJob?.cancel()
        predictionJob = viewModelScope.launch {
            try {
                // Add small delay for better UX
                delay(500)

                // Get prediction from HealthBotModel
                val prediction = try {
                    healthBotModel.predict(userMessage)
                } catch (e: Exception) {
                    // Fallback to simulated prediction if model fails
                    simulatePrediction(userMessage)
                }

                // Create bot response
                val botMessage = createBotResponse(userMessage, prediction)

                val botChatMessage = ChatMessage(
                    isUser = false,
                    message = botMessage,
                    predictions = prediction.predictions.joinToString("\n") {
                        "${it.label}: ${(it.probability * 100).toInt()}%"
                    },
                    sessionId = currentSessionId
                )

                _uiState.value = currentState.copy(
                    messages = currentState.messages + userChatMessage + botChatMessage,
                    isLoading = false,
                    inputText = "",
                    currentPrediction = prediction,
                    error = null
                )

            } catch (e: Exception) {
                _uiState.value = currentState.copy(
                    messages = currentState.messages + userChatMessage,
                    isLoading = false,
                    error = "Maaf, terjadi kesalahan. Silakan coba lagi."
                )
            }
        }
    }

    private fun simulatePrediction(text: String): HealthBotResponse {
        // Simulate ML prediction (replace with real implementation)
        val possiblePredictions = listOf(
            HealthBotPrediction("1-FR", 0.85f, "Febrile Illness"),
            HealthBotPrediction("2-GI", 0.75f, "Gastrointestinal"),
            HealthBotPrediction("3-PI", 0.65f, "Parasitic Infections"),
            HealthBotPrediction("4-DM", 0.95f, "Diabetes Mellitus"),
            HealthBotPrediction("5-EDTRB", 0.70f, "Emergency Disorders"),
            HealthBotPrediction("6-RE", 0.60f, "Reproductive Disorders")
        )

        val selectedPredictions = if (text.contains("demam") || text.contains("panas")) {
            listOf(HealthBotPrediction("1-FR", 0.90f, "Febrile Illness"))
        } else if (text.contains("perut") || text.contains("muntah")) {
            listOf(HealthBotPrediction("2-GI", 0.85f, "Gastrointestinal"))
        } else if (text.contains("gula") || text.contains("kencing")) {
            listOf(HealthBotPrediction("4-DM", 0.95f, "Diabetes Mellitus"))
        } else {
            emptyList()
        }

        val emergencyLevel = when {
            selectedPredictions.any { it.label == "4-DM" } -> EmergencyLevel.HIGH
            selectedPredictions.any { it.label == "1-FR" || it.label == "5-EDTRB" } -> EmergencyLevel.MEDIUM
            else -> EmergencyLevel.LOW
        }

        val recommendations = generateRecommendations(selectedPredictions)

        return HealthBotResponse(
            predictions = selectedPredictions,
            recommendations = recommendations,
            emergencyLevel = emergencyLevel
        )
    }

    private fun createBotResponse(userMessage: String, prediction: HealthBotResponse): String {
        if (prediction.predictions.isEmpty()) {
            return "Halo! Saya HealthBot, asisten kesehatan Anda. Saya siap membantu mengidentifikasi gejala kesehatan Anda.\n\n" +
                    "Silakan ceritakan gejala yang Anda alami dengan detail, misalnya:\n" +
                    "• \"Saya demam sejak kemarin, suhu badan 38.5°C\"\n" +
                    "• \"Perut saya mules dan diare\"\n" +
                    "• \"Saya sering haus dan sering buang air kecil\""
        }

        var response = "Berdasarkan gejala yang Anda sebutkan:\n\n"

        prediction.predictions.forEach { pred ->
            response += "• ${pred.description} (${(pred.probability * 100).toInt}% kemungkinan)\n"
        }

        if (prediction.recommendations.isNotEmpty()) {
            response += "\nRekomendasi:\n"
            prediction.recommendations.forEach { rec ->
                response += "• $rec\n"
            }
        }

        response += "\nDisclaimer: Ini bukan diagnosis medis. Untuk diagnosis akurat, silakan konsultasi dengan dokter."

        return response
    }

    private fun generateRecommendations(predictions: List<HealthBotPrediction>): List<String> {
        val recommendations = mutableListOf<String>()

        if (predictions.isEmpty()) {
            return listOf("Silakan jelaskan gejala Anda lebih detail.")
        }

        predictions.forEach { pred ->
            when (pred.label) {
                "4-DM" -> {
                    recommendations.add("⚠️ SEGERA ke dokter! Gejala diabetes perlu penanganan medis.")
                    recommendations.add("Monitor gula darah secara rutin.")
                    recommendations.add("Perhatikan pola makan dan obat diabetes.")
                }
                "1-FR" -> {
                    recommendations.add("Minum paracetamol jika demam >38°C.")
                    recommendations.add("Kompres dengan air hangat.")
                    recommendations.add("Banyak minum air putih.")
                    recommendations.add("Jika demam >3 hari, ke dokter.")
                }
                "2-GI" -> {
                    recommendations.add("Hindari makanan pedas dan berminyak.")
                    recommendations.add("Minum air putih yang banyak.")
                    recommendations.add("Jika diare, minum ORS.")
                    recommendations.add("Istirahat perut (makan bubur atau nasi hangat).")
                }
            }
        }

        return recommendations.distinct()
    }

    fun clearError() {
        _uiState.value = _uiState.value.copy(error = null)
    }

    fun clearChat() {
        _uiState.value = HealthBotUiState()
    }

    override fun onCleared() {
        super.onCleared()
        predictionJob?.cancel()
    }
}